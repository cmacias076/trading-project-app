{% extends 'trading/base.html' %}

{% block title %}My Portfolio{% endblock %}

{% block content %}
<div class="container">

  <h1 class="mb-4">ðŸ’¼ My Portfolio</h1>

  <!-- Portfolio summary -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title"><i class="bi bi-cash-stack"></i> Cash Balance</h6>
          <p class="fs-5 fw-bold text-primary">${{ portfolio.cash_balance|floatformat:2 }}</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title"><i class="bi bi-piggy-bank"></i> Total Value</h6>
          <p class="fs-5 fw-bold text-success">${{ total_value|floatformat:2 }}</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <h6 class="card-title"><i class="bi bi-graph-up"></i> Gain / Loss</h6>
          {% if gain_loss_percent is not None %}
            <p class="fs-5 fw-bold {% if gain_loss_percent >= 0 %}text-success{% else %}text-danger{% endif %}">
              {% if gain_loss_percent >= 0 %}
                <i class="bi bi-arrow-up-circle-fill"></i>
              {% else %}
                <i class="bi bi-arrow-down-circle-fill"></i>
              {% endif %}
              {{ gain_loss_percent|floatformat:2 }}%
            </p>
          {% else %}
            <p class="text-muted">â€”</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Reset button -->
  <form method="post" action="{% url 'reset_portfolio' %}" class="mb-4 text-end">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger">ðŸ”„ Reset Portfolio</button>
  </form>

  <!-- Holdings -->
  <h2 class="mb-3">ðŸ“Š Holdings</h2>
  <ul class="list-group mb-4">
    {% for holding in holdings %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <a href="{% url 'instrument_detail' holding.instrument.symbol %}" class="fw-bold">
            {{ holding.instrument.symbol }}
          </a>
          â€” {{ holding.quantity|floatformat:2 }} shares
        </div>
        <form method="post" action="{% url 'sell_instrument' holding.instrument.symbol %}" class="d-flex gap-2">
          {% csrf_token %}
          <input type="number" name="quantity" min="1" max="{{ holding.quantity }}" class="form-control form-control-sm" required>
          <button type="submit" class="btn btn-sm btn-warning">Sell</button>
        </form>
      </li>
    {% empty %}
      <li class="list-group-item text-muted">No holdings yet.</li>
    {% endfor %}
  </ul>

  <!-- Transactions -->
  <h2 class="mb-3">ðŸ“œ Transactions</h2>
  <ul class="list-group mb-4">
    {% for tx in transactions %}
      <li class="list-group-item">
        <span class="text-muted">{{ tx.timestamp }}</span> â€” 
        <strong>{{ tx.type }}</strong> 
        {{ tx.quantity|floatformat:2 }} 
        <a href="{% url 'instrument_detail' tx.instrument.symbol %}" class="fw-bold">{{ tx.instrument.symbol }}</a> 
        @ ${{ tx.price|floatformat:2 }}
        <span class="text-muted">(total ${{ tx.total_value|floatformat:2 }})</span>
      </li>
    {% empty %}
      <li class="list-group-item text-muted">No transactions yet.</li>
    {% endfor %}
  </ul>

  <!-- Chart -->
  <h2 class="mb-3">ðŸ“ˆ Portfolio Value Over Time</h2>
  <div class="card shadow-sm p-3 mb-5">
    <canvas id="portfolioChart"></canvas>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const dates = JSON.parse('{{ snapshot_dates|escapejs }}');
const values = JSON.parse('{{ snapshot_values|escapejs }}');

const ctx = document.getElementById('portfolioChart').getContext('2d');
const gradient = ctx.createLinearGradient(0, 0, 0, 400);
gradient.addColorStop(0, 'rgba(13, 110, 253, 0.4)');
gradient.addColorStop(1, 'rgba(13, 110, 253, 0)');

new Chart(ctx, {
  type: 'line',
  data: {
    labels: dates,
    datasets: [{
      label: 'Portfolio Value',
      data: values,
      borderColor: 'rgba(13, 110, 253, 1)',
      backgroundColor: gradient,
      fill: true,
      tension: 0.3,
      pointRadius: 3,
      pointHoverRadius: 6
    }]
  },
  options: {
    responsive: true,
    plugins: {
      tooltip: {
        enabled: true,
        mode: 'index',
        intersect: false,
        callbacks: {
          label: function(context) {
            return `$${context.formattedValue}`;
          }
        }
      },
      legend: { display: false }
    },
    scales: {
      x: { title: { display: true, text: 'Date' }},
      y: { title: { display: true, text: 'Value (USD)' }}
    }
  }
});
</script>
{% endblock %}
