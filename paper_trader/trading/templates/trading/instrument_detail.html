{% extends 'trading/base.html' %}

{% block title %}{{ instrument.name }} ({{ instrument.symbol }}){% endblock %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex gap-2 mb-3">
    <a href="{% url 'instrument_list' %}" class="btn btn-outline-primary btn-sm">‚Üê Back to Instruments</a>
    <a href="{% url 'portfolio' %}" class="btn btn-outline-secondary btn-sm">View Portfolio</a>
  </div>

  <!-- Instrument Summary -->
  <div class="card shadow-sm p-4 mb-4">
    <h1 class="mb-3">{{ instrument.name }} ({{ instrument.symbol }})</h1>
    <p>
      <strong>Latest Price:</strong> ${{ latest_price|floatformat:2 }}<br>
      <strong>Previous Close:</strong> ${{ previous_close|floatformat:2 }}
    </p>
  </div>

  <!-- Historical Prices Chart -->
  <div class="card shadow-sm p-4 mb-4">
    <h3 class="mb-3">üìä Historical Prices (Last 30 Days)</h3>
    <canvas id="priceChart" width="800" height="400"></canvas>
  </div>

  <!-- Buy Form -->
  <div class="card shadow-sm p-4 mb-4">
    <h3 class="mb-3">üí∞ Buy {{ instrument.symbol }}</h3>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <form method="post" class="d-flex flex-column flex-sm-row gap-2 align-items-start">
      {% csrf_token %}
      <div class="mb-2">
        {{ form.quantity.label_tag }}
        {{ form.quantity }}
      </div>
      <button type="submit" class="btn btn-primary mt-2 mt-sm-0">Buy</button>
    </form>

    <p class="mt-3"><strong>Available Cash:</strong> ${{ portfolio.cash_balance|floatformat:2 }}</p>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const dates = JSON.parse('{{ dates_json|escapejs }}');
const closePrices = JSON.parse('{{ close_prices_json|escapejs }}');

const ctx = document.getElementById('priceChart').getContext('2d');
const gradient = ctx.createLinearGradient(0, 0, 0, 400);
gradient.addColorStop(0, 'rgba(13, 110, 253, 0.4)');
gradient.addColorStop(1, 'rgba(13, 110, 253, 0)');

new Chart(ctx, {
  type: 'line',
  data: {
    labels: dates,
    datasets: [{
      label: 'Close Price',
      data: closePrices,
      borderColor: 'rgba(13, 110, 253, 1)',
      backgroundColor: gradient,
      fill: true,
      tension: 0.3,
      pointRadius: 3,
      pointHoverRadius: 6
    }]
  },
  options: {
    responsive: true,
    plugins: {
      tooltip: {
        enabled: true,
        mode: 'index',
        intersect: false,
        callbacks: {
          label: function(context) { return `$${context.formattedValue}`; }
        }
      },
      legend: { display: false }
    },
    scales: {
      x: { title: { display: true, text: 'Date' }},
      y: { title: { display: true, text: 'Price (USD)' }}
    }
  }
});
</script>
{% endblock %}
