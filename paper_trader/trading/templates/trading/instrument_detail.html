{% extends 'trading/base.html' %}

{% block title %}{{ instrument.name }} ({{ instrument.symbol }}){% endblock %}

{% block content %}
<div class="container mt-4">

  <div class="mb-3">
    <a href="{% url 'instrument_list' %}" class="btn btn-outline-primary btn-sm">‚Üê Back to Instruments</a>
    <a href="{% url 'portfolio' %}" class="btn btn-outline-secondary btn-sm">View Portfolio</a>
  </div>

  <div class="card shadow-sm p-4 mb-4">
    <h1 class="mb-3">{{ instrument.name }} ({{ instrument.symbol }})</h1>
    <p>
      <strong>Latest Price:</strong> ${{ latest_price|floatformat:2 }}<br>
      <strong>Previous Close:</strong> ${{ previous_close|floatformat:2 }}
    </p>
  </div>

  <div class="card shadow-sm p-4 mb-4">
    <h3 class="mb-3">Historical Prices (Last 30 Days)</h3>
    <canvas id="priceChart" class="mb-3"></canvas>
  </div>

  <div class="card shadow-sm p-4 mb-4">
    <h3 class="mb-3">Buy {{ instrument.symbol }}</h3>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <form method="post" class="d-flex flex-column flex-sm-row gap-2 align-items-start">
      {% csrf_token %}
      <div class="mb-2">
        {{ form.quantity.label_tag }}
        {{ form.quantity }}
      </div>
      <button type="submit" class="btn btn-primary mt-2 mt-sm-0">Buy</button>
    </form>

    <p class="mt-3"><strong>Available Cash:</strong> ${{ portfolio.cash_balance|floatformat:2 }}</p>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const dates = JSON.parse('{{ dates_json|escapejs }}');
  const closePrices = JSON.parse('{{ close_prices_json|escapejs }}');

  const ctx = document.getElementById('priceChart').getContext('2d');
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(75, 192, 192, 0.3)');
  gradient.addColorStop(1, 'rgba(75, 192, 192, 0)');

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Close Price',
        data: closePrices,
        borderColor: 'rgba(75, 192, 192, 1)',
        backgroundColor: gradient,
        fill: true,
        tension: 0.3,
        pointHoverRadius: 6,
        pointHoverBackgroundColor: 'rgba(0,123,255,1)'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: { mode: 'index', intersect: false }
      },
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      },
      scales: {
        x: { title: { display: true, text: 'Date' }},
        y: { title: { display: true, text: 'Price (USD)' }}
      }
    }
  });

  // Initialize tooltips
  const tooltipList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipList.map(el => new bootstrap.Tooltip(el));
</script>
{% endblock %}
