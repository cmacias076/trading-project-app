{% extends 'trading/base.html' %}

{% block title %}{{ instrument.name }} ({{ instrument.symbol }}){% endblock %}

{% block content %}
  <div class="mb-3">
    <a href="{% url 'instrument_list' %}" class="btn btn-outline-primary btn-sm">‚Üê Back to Instruments</a>
    <a href="{% url 'sell_instrument' instrument.symbol %}" class="btn btn-warning btn-sm">Sell {{ instrument.symbol }}</a>
  </div>

  <h1>{{ instrument.name }} ({{ instrument.symbol }})</h1>

  <p>
    Latest Price: ${{ latest_price }}<br />
    Previous Close: ${{ previous_close }}
  </p>

  <h3>Historical Prices (Last 30 Days)</h3>
  <canvas id="priceChart" width="800" height="400"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const dates = JSON.parse('{{ dates_json|escapejs }}');
    const closePrices = JSON.parse('{{ close_prices_json|escapejs }}');

    new Chart(document.getElementById('priceChart').getContext('2d'), {
      type: 'line',
      data: {
        labels: dates,
        datasets: [{
          label: 'Close Price',
          data: closePrices,
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          fill: true,
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Date' }},
          y: { title: { display: true, text: 'Price (USD)' }}
        }
      }
    });
  </script>

  <h3 class="mt-4">Buy {{ instrument.symbol }}</h3>
  <form method="post" class="mb-4">
    {% csrf_token %}
    <div class="mb-3">
      {{ form.quantity.label_tag }}
      {{ form.quantity }}
    </div>
    <button type="submit" class="btn btn-primary">Buy</button>
  </form>

  <p><strong>Available Cash:</strong> ${{ portfolio.cash_balance }}</p>
{% endblock %}
